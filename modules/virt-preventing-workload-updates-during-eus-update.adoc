// Module included in the following assemblies:
//
// * virt/upgrading-virt.adoc

:_content-type: PROCEDURE
[id="virt-preventing-workload-updates-during-eus-update_{context}"]
= Preventing workload updates during an EUS-to-EUS update

When you update from one Extended Update Support (EUS) version to the next, you must manually disable automatic workload updates to prevent {VirtProductName} from migrating or evicting workloads during the update process.

.Prerequisites

* You are running an EUS version of {product-title} and want to update to the next EUS version. You have not yet updated to the odd-numbered version in between.

* You read "Preparing to perform an EUS-to-EUS update" and learned the caveats and requirements that pertain to your {product-title} cluster.

* You paused the worker nodes' machine config pools as directed by the {product-title} documentation.

.Procedure

. Back up the current `workloadUpdateMethods` configuration by running the following command:
+
[source,terminal]
----
$ WORKLOAD_UPDATE_METHODS=$(oc get kv kubevirt-kubevirt-hyperconverged -n openshift-cnv -o jsonpath='{.spec.workloadUpdateStrategy.workloadUpdateMethods}')
----

. Turn off all workload update methods by running the following command:
+
[source,terminal]
----
$ oc patch hco kubevirt-hyperconverged -n openshift-cnv --type json -p '[{"op":"replace","path":"/spec/workloadUpdateStrategy/workloadUpdateMethods", "value":[]}]'
----
+
.Example output
[source,terminal]
----
hyperconverged.hco.kubevirt.io/kubevirt-hyperconverged patched
----

. Ensure that the `HyperConverged` Operator is `Upgradeable` before you continue. Enter the following command and monitor the output:
+
[source,terminal]
----
$ oc get hco kubevirt-hyperconverged -n openshift-cnv -o json | jq ".status.conditions"
----
+
.Example output
[%collapsible]
====
[source,json]
----
[
  {
    "lastTransitionTime": "2022-12-09T16:29:11Z",
    "message": "Reconcile completed successfully",
    "observedGeneration": 3,
    "reason": "ReconcileCompleted",
    "status": "True",
    "type": "ReconcileComplete"
  },
  {
    "lastTransitionTime": "2022-12-09T20:30:10Z",
    "message": "Reconcile completed successfully",
    "observedGeneration": 3,
    "reason": "ReconcileCompleted",
    "status": "True",
    "type": "Available"
  },
  {
    "lastTransitionTime": "2022-12-09T20:30:10Z",
    "message": "Reconcile completed successfully",
    "observedGeneration": 3,
    "reason": "ReconcileCompleted",
    "status": "False",
    "type": "Progressing"
  },
  {
    "lastTransitionTime": "2022-12-09T16:39:11Z",
    "message": "Reconcile completed successfully",
    "observedGeneration": 3,
    "reason": "ReconcileCompleted",
    "status": "False",
    "type": "Degraded"
  },
  {
    "lastTransitionTime": "2022-12-09T20:30:10Z",
    "message": "Reconcile completed successfully",
    "observedGeneration": 3,
    "reason": "ReconcileCompleted",
    "status": "True",
    "type": "Upgradeable" <1>
  }
]
----
====
<1> The {VirtProductName} Operator has the `Upgradeable` status.

. Manually update your cluster from the source EUS version to the next minor version of {product-title}:
+
[source,terminal]
+
----
$ oc adm upgrade
----
+
.Verification
* Check the current version by running the following command:
+
[source,terminal]
----
$ oc get clusterversion
----
+
[NOTE]
====
Updating {product-title} to the next version is a prerequisite for updating {VirtProductName}. For more details, refer to the "Updating clusters" section of the {product-title} documentation.
====

. If you use the recommended *Automatic* approval strategy, which is enabled by default, {VirtProductName} automatically updates to the corresponding version after you update {product-title}. Monitor the {VirtProductName} update by running the following command:
+
[source,terminal]
----
$ oc get csv -n openshift-cnv
----
+
[NOTE]
====
If you used the *Manual* approval strategy, you must approve the update in the web console. For more details, refer to the "Manually approving a pending Operator update" section.
====

. Confirm that {VirtProductName} successfully updated to the non-EUS version by running the following command:
+
[source,terminal]
----
$ oc get hco kubevirt-hyperconverged -n openshift-cnv -o json | jq ".status.versions"
----
+
.Example output
[source,terminal]
----
[
  {
    "name": "operator",
    "version": "{HCOVersion}"
  }
]
----

. Wait until the `HyperConverged` Operator has the `Upgradeable` status before you perform the next update. Enter the following command and monitor the output:
+
[source,terminal]
----
$ oc get hco kubevirt-hyperconverged -n openshift-cnv -o json | jq ".status.conditions"
----

. Continue to update your cluster and {VirtProductName} as described in the preceding steps, monitoring to ensure that the updates succeed.
.. Update {product-title} and, subsequently, {VirtProductName}, until you install the latest z-stream release of the non-EUS minor version. Ensure that you update both {product-title} and {VirtProductName} to this version.
.. Update {product-title} to the target EUS version.
.. Update {VirtProductName} to the target EUS version.

. Restore the workload update methods configuration that you backed up:
+
[source,terminal]
----
$ oc patch hco kubevirt-hyperconverged -n openshift-cnv --type json -p "[{\"op\":\"add\",\"path\":\"/spec/workloadUpdateStrategy/workloadUpdateMethods\", \"value\":$WORKLOAD_UPDATE_METHODS}]"
----
+
.Example output
[source,terminal]
----
hyperconverged.hco.kubevirt.io/kubevirt-hyperconverged patched
----
+
.Verification

* Check the status of VM migration by running the following command:
+
[source,terminal]
----
$ oc get vmim -A
----

.Next steps

* You can now unpause the worker nodes' machine config pools.