// Module included in the following assemblies:
//
// scalability_and_performance/ztp-advanced-policy-config.adoc

:_module-type: PROCEDURE
[id="ztp-configuring-pgt-image-registry_{context}"]
= Configuring the image registry using PolicyGenTemplate CRs

You can use `PolicyGenTemplate` to apply to create the PV and PVC and patch `imageregistry` configuration. Select the appropriate `PolicyGenTemplate` for each `source-cr`. See Additional Resources for more help.

.Prerequisites

* You have installed and configured Zero Touch Provisioning (ZTP). For information about this, see the topic on ZTP in Additional resources.

.Procedure

. Configure the storage class, persistent volume claim, persistent volume, and image registry configuration in the appropriate `PolicyGenTemplate` CR. For example, to configure an individual site, use the following YAML:
+
[source,yaml]
----
sourceFiles:
   # storage class
   - fileName: StorageClass.yaml
     policyName: "sc-for-image-registry"
     metadata:
       name: image-registry-sc
       annotations:
         ran.openshift.io/ztp-deploy-wave: "100" <1>
  # persistent volume claim
   - fileName: StoragePVC.yaml
    policyName: "pvc-for-image-registry"
    metadata:
      name: image-registry-pvc
      namespace: openshift-image-registry
        annotations:
          ran.openshift.io/ztp-deploy-wave: "100"  <2>
    spec:
      accessModes:
        ReadWriteMany
      resources:
        requests:
          storage: 100Gi
      storageClassName: image-registry-sc
      volumeMode: Filesystem
  # persistent volume
  - fileName: ImageRegistryPV.yaml <3>
    policyName: "pv-for-image-registry"
    metadata:
      annotations:
        ran.openshift.io/ztp-deploy-wave: "100"  <4>
  # image registry config
  - fileName: ImageRegistryConfig.yaml <5>
    policyName: "config-for-image-registry"
    complianceType: musthave <5>
    metadata:
      annotations:
        ran.openshift.io/ztp-deploy-wave: "100" <6>
    spec:
      storage:
        pvc:
          claim: "image-registry-pvc"
----
<1> Set the appropriate value for `ztp-deploy-wave` depending on whether you are configuring image registries at the site, common, or group level. `ztp-deploy-wave: "100"` is appropriate for an individual site.  ZTP deploy waves are used to order how policies are applied to the spoke cluster. All policies created by `PolicyGen` have a ztp deploy wave by default.
<2> Set the appropriate value for `ztp-deploy-wave` as in note 1.
<3> This assumes that `mount_point` is set to `/var/imageregistry` in `SiteConfig` using StorageClass `image-registry-sc` (see the topic on configuring disk partitioning with `SiteConfig`).
<4> Set the appropriate value for `ztp-deploy-wave` as in note 1.
<5> Configure registry to point to the PVC created above.
<6> Set the appropriate value for `ztp-deploy-wave` as in note 1.

.Verification

. Check that the `Config` CRD of the group `imageregistry.operator.openshift.io` instance is not reporting errors. Run the following command:

. Check that the `PersistentVolumeClaim` on the managed cluster is populated with data. Run the following command:

. Check that the `registry*` pod is up correctly located under the `openshift-image-registry` namespace.

. Verify successful login to the registry with `podman`:
+
[source,terminal]
----
$ oc login -u kubeadmin -p <password_from_install_log> https://api-int.<cluster_name>.<base_domain>:6443
----
+
[source,terminal]
----
$ podman login -u kubeadmin -p $(oc whoami -t) image-registry.openshift-image-registry.svc:5000
----

. Check for disk partitioning using `lsblk` to list your blocks:
+
[source,terminal]
----
$ oc debug node/sno-1.example.com
----

. When you enter the node, run the following command:

[source,terminal]
----
sh-4.4# lsblk
NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
sda      8:0    0 446.6G  0 disk
  |-sda1   8:1    0     1M  0 part
  |-sda2   8:2    0   127M  0 part
  |-sda3   8:3    0   384M  0 part /boot
  |-sda4   8:4    0 336.3G  0 part /sysroot
  `-sda5   8:5    0 100.1G  0 part /var/imageregistry <1>
sdb      8:16   0 446.6G  0 disk
sr0     11:0    1   104M  0 rom
----
<1> This setting will appear if you have successfully listed your block.
